@page "/demo-carousel"

@attribute [StreamRendering]
@rendermode InteractiveServer

<section class="ng-carousel" id="ngc-1"
         style="--ng-max-width: 1024px; --ng-aspect-ratio: 21/9; --ng-duration: 4s; --ng-steps: @slides.Count; --ng-dot-w: 28px; --ng-dot-h: 5px; --ng-dot-radius: 999px; --ng-dot-color: red; --ng-dot-bg: rgba(255,255,255,.4);">

    <div class="ngc-viewport">
        <header class="ngc-header">
            <h3 class="ngc-header-title">@GetCurrentSlide()?.Titulo</h3>
            <p class="ngc-header-desc">@GetCurrentSlide()?.Descripcion</p>
        </header>

        @foreach (var slide in slides)
        {
            var isActive = slide.Numero == idActivo;
            var slideStyle = "";

            if (isAutoMode)
            {
                // En modo automático, usar animaciones CSS
                slideStyle = "";
            }
            else
            {
                // En modo manual, controlar completamente desde Blazor
                slideStyle = $"animation: none !important; opacity: {(isActive ? "1" : "0")}; visibility: {(isActive ? "visible" : "hidden")};";
            }

            <div class="ngc-slide @(isAutoMode ? "" : "manual-mode")"
                 id="@slide.Id"
                 style="@slideStyle">
                <img src="@slide.ImageUrl" alt="@slide.Titulo" />
            </div>
        }

        <nav class="ngc-arrows">
            <!-- Modo automático: flechas sin funcionalidad específica -->
            <div class="for-auto" style="@(isAutoMode ? "display: flex; align-items: center; justify-content: space-between; padding: 0 .5rem;" : "display: none;")">
                <a class="ngc-arrow prev" @onclick="ActivateManualMode" @onclick:preventDefault="true" aria-label="Activar modo manual">
                    <svg class="ngc-arrow-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M15 6 L9 12 L15 18" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </a>
                <a class="ngc-arrow next" @onclick="ActivateManualMode" @onclick:preventDefault="true" aria-label="Activar modo manual">
                    <svg class="ngc-arrow-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M9 6 L15 12 L9 18" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </a>
            </div>

            <!-- Modo manual: flechas funcionales -->
            <div class="for-manual" style="@(!isAutoMode ? "display: flex; align-items: center; justify-content: space-between; padding: 0 .5rem;" : "display: none;")">
                <a class="ngc-arrow prev" @onclick="SelPrev" @onclick:preventDefault="true" aria-label="Anterior">
                    <svg class="ngc-arrow-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M15 6 L9 12 L15 18" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </a>
                <a class="ngc-arrow next" @onclick="SelNext" @onclick:preventDefault="true" aria-label="Siguiente">
                    <svg class="ngc-arrow-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M9 6 L15 12 L9 18" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </a>
            </div>
        </nav>

        <div class="ngc-dots">
            @foreach (var slide in slides)
            {
                <a aria-label="Slide @slide.Numero"
                   @onclick="() => Seleccionar(slide)"
                   @onclick:preventDefault="true"
                   style="@(slide.Numero == idActivo ? "background: var(--ng-dot-color);" : "background: var(--ng-dot-bg);")"></a>
            }
        </div>

        <!-- Indicador de modo -->
        <div class="mode-indicator" style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 12px; z-index: 10;">
            @(isAutoMode ? "Auto" : "Manual")
        </div>
    </div>
</section>

<section style="margin-top:2rem; max-width:960px;">
    <p>Configurable por variables CSS:</p>
    <ul>
        <li><code>--ng-max-width</code> (ancho máximo)</li>
        <li><code>--ng-aspect-ratio</code> (relación de aspecto)</li>
        <li><code>--ng-duration</code> (tiempo por slide)</li>
        <li><code>--ng-steps</code> (cantidad de slides)</li>
        <li><code>--ng-dot-w</code> / <code>--ng-dot-h</code> / <code>--ng-dot-color</code> / <code>--ng-dot-bg</code> (dots)</li>
    </ul>

    <div style="margin-top: 1rem;">
        <button @onclick="ToggleMode" class="btn btn-primary">
            Cambiar a modo @(isAutoMode ? "Manual" : "Automático")
        </button>
        <button @onclick="ResetToStart" class="btn btn-secondary" style="margin-left: 0.5rem;">
            Reiniciar
        </button>
    </div>
</section>

@code {
    private int idActivo = 1; // Empezar con el primer slide
    private bool isAutoMode = true; // Por defecto en modo automático
    private List<SlideViewModel> slides = new List<SlideViewModel>();

    protected override async Task OnInitializedAsync()
    {
        slides = GetSlides();
        await Task.CompletedTask;
    }

    public void Seleccionar(SlideViewModel slide)
    {
        idActivo = slide.Numero;
        isAutoMode = false; // Cambiar a modo manual al hacer clic en dot
        StateHasChanged(); // Forzar re-render
    }

    public void SelPrev()
    {
        if (slides.Any())
        {
            var currentIndex = slides.FindIndex(s => s.Numero == idActivo);
            if (currentIndex > 0)
            {
                idActivo = slides[currentIndex - 1].Numero;
            }
            else
            {
                // Ir al último slide
                idActivo = slides.Last().Numero;
            }
            StateHasChanged(); // Forzar re-render
        }
    }

    public void SelNext()
    {
        if (slides.Any())
        {
            var currentIndex = slides.FindIndex(s => s.Numero == idActivo);
            if (currentIndex < slides.Count - 1)
            {
                idActivo = slides[currentIndex + 1].Numero;
            }
            else
            {
                // Ir al primer slide
                idActivo = slides.First().Numero;
            }
            StateHasChanged(); // Forzar re-render
        }
    }

    public void ActivateManualMode()
    {
        isAutoMode = false;
        StateHasChanged();
    }

    public void ToggleMode()
    {
        isAutoMode = !isAutoMode;
        if (isAutoMode)
        {
            // Al volver a modo automático, resetear al primer slide
            idActivo = slides.FirstOrDefault()?.Numero ?? 1;
        }
        StateHasChanged();
    }

    public void ResetToStart()
    {
        idActivo = slides.FirstOrDefault()?.Numero ?? 1;
        isAutoMode = true;
        StateHasChanged();
    }

    private SlideViewModel? GetCurrentSlide()
    {
        return slides.FirstOrDefault(s => s.Numero == idActivo);
    }

    #region ViewModel
    public class SlideViewModel
    {
        public int Numero { get; set; }
        public string Id { get; set; } = string.Empty;
        public string Previo { get; set; } = string.Empty;
        public string Siguiente { get; set; } = string.Empty;
        public string Titulo { get; set; } = string.Empty;
        public string Descripcion { get; set; } = string.Empty;
        public string ImageUrl { get; set; } = string.Empty;
    }
    #endregion

    #region Data
    private List<SlideViewModel> GetSlides()
    {
        return new List<SlideViewModel>
        {
            new SlideViewModel
            {
                Numero = 1,
                Id = "ngc-1-s1",
                Previo = "ngc-1-s3", // Último slide
                Siguiente = "ngc-1-s2",
                Titulo = "Municipio de Zárate",
                Descripcion = "Un municipio de buena gente!",
                ImageUrl = "img/slide1.png"
            },
            new SlideViewModel
            {
                Numero = 2,
                Id = "ngc-1-s2",
                Previo = "ngc-1-s1",
                Siguiente = "ngc-1-s3",
                Titulo = "Municipio de Tres Arroyos",
                Descripcion = "Un municipio de buenas personas!",
                ImageUrl = "img/slide2.png"
            },
            new SlideViewModel
            {
                Numero = 3,
                Id = "ngc-1-s3",
                Previo = "ngc-1-s2",
                Siguiente = "ngc-1-s1", // Primer slide
                Titulo = "Municipio de Esperanza",
                Descripcion = "Un municipio de buenos seres humanos!",
                ImageUrl = "img/slide3.png"
            }
        };
    }
    #endregion
}